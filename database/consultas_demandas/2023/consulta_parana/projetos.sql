\COPY (SELECT projeto.id_projeto, projeto.id_osc, projeto.tx_descricao_projeto, projeto.tx_nome_status_projeto, projeto.dt_data_inicio_projeto, projeto.dt_data_fim_projeto, projeto.nr_valor_total_projeto, projeto.nr_valor_captado_projeto, projeto.tx_nome_abrangencia_projeto, projeto.tx_nome_zona_atuacao, STRING_AGG(fonte_recursos.tx_nome_origem_fonte_recursos_projeto,', ') AS tx_nome_origem_fonte_recursos_projeto, STRING_AGG(objetivo.tx_nome_objetivo_projeto, ', ') AS tx_nome_objetivo_projeto, STRING_AGG(objetivo.tx_nome_meta_projeto, ', ') AS tx_nome_meta_projeto FROM osc.tb_osc LEFT JOIN osc.tb_localizacao ON tb_osc.id_osc = tb_localizacao.id_osc LEFT JOIN spat.ed_municipio ON ed_municipio.edmu_cd_municipio = tb_localizacao.cd_municipio LEFT JOIN spat.ed_uf ON ed_uf.eduf_cd_uf = substr(tb_localizacao.cd_municipio::TEXT, 0, 3)::NUMERIC(2,0) JOIN portal.vw_osc_projeto AS projeto ON projeto.id_osc = tb_osc.id_osc LEFT JOIN portal.vw_osc_fonte_recursos_projeto AS fonte_recursos ON projeto.id_projeto = fonte_recursos.id_projeto LEFT JOIN portal.vw_osc_publico_beneficiado_projeto ON projeto.id_projeto = vw_osc_publico_beneficiado_projeto.id_projeto LEFT JOIN portal.vw_osc_objetivo_projeto AS objetivo ON projeto.id_projeto = objetivo.id_projeto WHERE tb_osc.bo_osc_ativa AND ed_uf.eduf_sg_uf = 'PR' GROUP BY projeto.id_projeto, projeto.id_osc, projeto.tx_descricao_projeto, projeto.tx_nome_status_projeto, projeto.dt_data_inicio_projeto, projeto.dt_data_fim_projeto, projeto.nr_valor_total_projeto, projeto.nr_valor_captado_projeto, projeto.tx_nome_abrangencia_projeto, projeto.tx_nome_zona_atuacao) TO 'projetos_oscs_parana.csv' WITH (FORMAT CSV, HEADER, DELIMITER ';');

